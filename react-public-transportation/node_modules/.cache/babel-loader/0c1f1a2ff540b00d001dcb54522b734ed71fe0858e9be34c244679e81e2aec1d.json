{"ast":null,"code":"var _jsxFileName = \"/home/yaniv/101_coding/publicTransportation/react/public-transportation/src/MapView.js\",\n  _s2 = $RefreshSig$();\nimport { useEffect, useState, useRef, useMemo } from 'react';\nimport './App.css';\nimport { MapContainer, TileLayer, Marker, Popup, Polyline, useMap } from 'react-leaflet';\nimport L from 'leaflet'; // Added this import to fix the 'L is not defined' error\nimport 'leaflet/dist/leaflet.css';\nimport axios from 'axios';\nimport { TrackMapMovement, UpdateMapView, fetchAddress, findRoute } from './components/map/MapUtilities';\nimport { configureDefaultLeafletIcons, destinationIcon, centerIcon, vehicleIcon, stopIcon } from './components/map/MapMarkers';\nimport MapControls from './components/map/MapControls';\n\n// Configure default Leaflet icons\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconfigureDefaultLeafletIcons();\n\n/**\n * Simplifies a polyline by reducing the number of points\n * Uses the Ramer-Douglas-Peucker algorithm\n * @param {Array} points - Array of [lat, lng] coordinates\n * @param {Number} tolerance - Higher values mean more simplification\n * @returns {Array} - Simplified array of points\n */\nfunction simplifyShape(points, tolerance = 0.0001) {\n  if (!points || points.length <= 2) return points;\n\n  // Create map instance at the beginning so it's available to all inner functions\n  const dummyMap = L.map(document.createElement('div'));\n  const rdp = (pts, start, end, epsilon) => {\n    // Find the point with the maximum distance\n    let dmax = 0;\n    let index = 0;\n    const line = L.polyline([pts[start], pts[end]]);\n    const lineLatLngs = line.getLatLngs();\n    for (let i = start + 1; i < end; i++) {\n      const point = L.latLng(pts[i]);\n      const distance = L.GeometryUtil.distanceSegment(dummyMap, point, lineLatLngs[0], lineLatLngs[1]);\n      if (distance > dmax) {\n        index = i;\n        dmax = distance;\n      }\n    }\n\n    // If max distance is greater than epsilon, recursively simplify\n    const result = [];\n    if (dmax > epsilon) {\n      const res1 = rdp(pts, start, index, epsilon);\n      const res2 = rdp(pts, index, end, epsilon);\n\n      // Concat the results, removing the duplicate point\n      result.push(...res1.slice(0, -1));\n      result.push(...res2);\n    } else {\n      result.push(pts[start]);\n      result.push(pts[end]);\n    }\n    return result;\n  };\n\n  // Simple decimation as fallback - keep only every nth point\n  const decimate = (pts, factor = 4) => {\n    return pts.filter((_, idx) => idx % factor === 0 || idx === pts.length - 1);\n  };\n  try {\n    // First do simple decimation to reduce the number of points\n    const decimated = points.length > 500 ? decimate(points) : points;\n\n    // If we still have a lot of points, use RDP algorithm\n    if (decimated.length > 300) {\n      // For very large datasets, increase the tolerance\n      const adjustedTolerance = tolerance * Math.log10(decimated.length);\n      const simplified = rdp(decimated, 0, decimated.length - 1, adjustedTolerance);\n      dummyMap.remove(); // Clean up the map\n      return simplified;\n    }\n    dummyMap.remove(); // Make sure to clean up\n    return decimated;\n  } catch (err) {\n    console.error('Error simplifying route shape:', err);\n    // Clean up the map in case of error\n    dummyMap.remove();\n    // Fall back to simple decimation\n    return decimate(points, 6);\n  }\n}\nfunction MapView({\n  latitude,\n  longitude,\n  destination,\n  onDestinationSet,\n  startingPoint,\n  mapCenter: initialMapCenter,\n  vehicleMarkers = [],\n  routeShape = null,\n  stops = [],\n  selectedStop = null,\n  center\n}) {\n  _s2();\n  var _s = $RefreshSig$(),\n    _mapCenter$,\n    _mapCenter$2;\n  const [position, setPosition] = useState([latitude, longitude]);\n  const [positionAddress, setPositionAddress] = useState('');\n  const [destinationAddress, setDestinationAddress] = useState('');\n  const [route, setRoute] = useState(null);\n  const [searchQuery, setSearchQuery] = useState('');\n  const [searchError, setSearchError] = useState(null);\n  const [mapReady, setMapReady] = useState(false);\n  const [mapCenter, setMapCenter] = useState(center || initialMapCenter || [latitude, longitude]);\n  useEffect(() => {\n    const style = document.createElement('style');\n    style.innerHTML = `\n      .destination-marker {\n        filter: hue-rotate(120deg);\n      }\n    `;\n    document.head.appendChild(style);\n    return () => {\n      document.head.removeChild(style);\n    };\n  }, []);\n  useEffect(() => {\n    setPosition([latitude, longitude]);\n    fetchAddress(latitude, longitude, setPositionAddress);\n  }, [latitude, longitude]);\n  useEffect(() => {\n    if (destination) {\n      const newCenter = [(position[0] + destination[0]) / 2, (position[1] + destination[1]) / 2];\n      setMapCenter(newCenter);\n      fetchAddress(destination[0], destination[1], setDestinationAddress);\n    }\n  }, [position, destination]);\n\n  // Memoize and simplify the route shape to improve performance\n  const optimizedRouteShape = useMemo(() => {\n    if (!routeShape || !Array.isArray(routeShape) || routeShape.length < 3) {\n      return routeShape;\n    }\n    console.log(`Simplifying route shape with ${routeShape.length} points...`);\n\n    // Determine if we need to simplify (only for large routes)\n    if (routeShape.length > 300) {\n      // Stronger simplification for very large routes\n      const factor = routeShape.length > 1000 ? 0.00015 : 0.0001;\n      const simplified = simplifyShape(routeShape, factor);\n      console.log(`Simplified to ${simplified.length} points (${Math.round(simplified.length / routeShape.length * 100)}%)`);\n      return simplified;\n    }\n    return routeShape;\n  }, [routeShape]);\n\n  // Log routeShape when it changes to debug\n  useEffect(() => {\n    if (routeShape) {\n      console.log(\"Route shape received in MapView:\", routeShape.length, \"points\");\n      console.log(\"First point:\", routeShape[0]);\n      console.log(\"Last point:\", routeShape[routeShape.length - 1]);\n    }\n  }, [routeShape]);\n\n  // MapEffect component to update view and zoom when routeShape changes\n  const MapEffect = ({\n    routeShape\n  }) => {\n    _s();\n    const map = useMap();\n    const fittedRef = useRef(false);\n    const routeIdRef = useRef(null);\n    const processingRef = useRef(false);\n\n    // Generate a unique ID for the current route to detect changes\n    const currentRouteId = routeShape ? JSON.stringify(routeShape.slice(0, 2)) : null;\n    useEffect(() => {\n      // Skip if processing is in progress or if this is the same route\n      if (processingRef.current || routeIdRef.current === currentRouteId && fittedRef.current) {\n        return;\n      }\n\n      // Only fit bounds if:\n      // 1. We have a valid route shape with points\n      // 2. Either we haven't fitted bounds yet, or the route has changed\n      if (routeShape && routeShape.length > 0) {\n        processingRef.current = true;\n        try {\n          // Use setTimeout to give the browser a chance to breathe\n          setTimeout(() => {\n            try {\n              // Create a bounds object from the route shape\n              const bounds = routeShape.reduce((bounds, point) => {\n                bounds.extend(point);\n                return bounds;\n              }, L.latLngBounds(routeShape[0], routeShape[0]));\n\n              // Fit the map to these bounds with some padding\n              map.fitBounds(bounds, {\n                padding: [50, 50],\n                maxZoom: 15,\n                // Limit max zoom level\n                animate: true\n              });\n              console.log(\"Map fitted to route bounds\");\n\n              // Mark that we've fitted bounds for this route\n              fittedRef.current = true;\n              routeIdRef.current = currentRouteId;\n            } catch (e) {\n              console.error(\"Error fitting map to route:\", e);\n            } finally {\n              processingRef.current = false;\n            }\n          }, 100);\n        } catch (e) {\n          console.error(\"Error in MapEffect timeout:\", e);\n          processingRef.current = false;\n        }\n      }\n    }, [map, routeShape, currentRouteId]);\n\n    // Clean up function\n    useEffect(() => {\n      return () => {\n        processingRef.current = false;\n      };\n    }, []);\n    return null;\n  };\n  _s(MapEffect, \"wWYBugCGexn/wUFL9bcf+nyOIxY=\", false, function () {\n    return [useMap];\n  });\n  const handleSearch = async () => {\n    if (!searchQuery.trim()) return;\n    try {\n      setSearchError(null);\n      const response = await axios.get(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(searchQuery)}&format=json`);\n      if (response.data.length > 0) {\n        const {\n          lat,\n          lon\n        } = response.data[0];\n        setMapCenter([parseFloat(lat), parseFloat(lon)]);\n      } else {\n        setSearchError('Location not found.');\n      }\n    } catch (error) {\n      setSearchError('Error fetching location. Please try again.');\n    }\n  };\n  const handleSetStartPoint = () => {\n    setPosition(mapCenter);\n    fetchAddress(mapCenter[0], mapCenter[1], setPositionAddress);\n  };\n  const handleSetDestinationPoint = () => {\n    const newDestination = mapCenter;\n    onDestinationSet(newDestination);\n    fetchAddress(newDestination[0], newDestination[1], setDestinationAddress);\n  };\n  const handleKeyPress = e => {\n    if (e.key === 'Enter') {\n      handleSearch();\n    }\n  };\n  const handleFindRoute = async () => {\n    if (!destination) {\n      setSearchError('Please set a destination first.');\n      return;\n    }\n    const MAX_RETRIES = 3;\n    let attempts = 0;\n    while (attempts < MAX_RETRIES) {\n      try {\n        setSearchError(null);\n        const routeData = await findRoute(position, destination);\n        if (routeData) {\n          setRoute(routeData);\n          return;\n        } else {\n          setSearchError('No route found. Please try again with different locations.');\n          return;\n        }\n      } catch (error) {\n        attempts++;\n        if (attempts >= MAX_RETRIES) {\n          if (error.response && error.response.status === 403) {\n            setSearchError('Invalid API key or insufficient permissions.');\n          } else if (error.response && error.response.status === 503) {\n            setSearchError('Service unavailable. Please try again later.');\n          } else {\n            setSearchError('Error fetching route. Please try again.');\n          }\n        }\n      }\n    }\n  };\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    style: {\n      height: '100vh',\n      width: '100%'\n    },\n    children: [/*#__PURE__*/_jsxDEV(MapControls, {\n      searchQuery: searchQuery,\n      setSearchQuery: setSearchQuery,\n      handleSearch: handleSearch,\n      handleKeyPress: handleKeyPress,\n      handleSetStartPoint: handleSetStartPoint,\n      handleSetDestinationPoint: handleSetDestinationPoint,\n      handleFindRoute: handleFindRoute,\n      searchError: searchError,\n      positionAddress: positionAddress,\n      destinationAddress: destinationAddress\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 312,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(MapContainer, {\n      center: mapCenter,\n      zoom: 13,\n      style: {\n        height: '100%',\n        width: '100%'\n      },\n      zoomControl: false,\n      whenReady: () => setMapReady(true),\n      preferCanvas: true // Use canvas renderer for better performance\n      ,\n      children: [/*#__PURE__*/_jsxDEV(TileLayer, {\n        url: \"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\",\n        attribution: \"\\xA9 <a href=\\\"https://www.openstreetmap.org/copyright\\\">OpenStreetMap</a> contributors\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 333,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(UpdateMapView, {\n        position: mapCenter\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 337,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(TrackMapMovement, {\n        setMapCenter: setMapCenter\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 338,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(MapEffect, {\n        routeShape: optimizedRouteShape\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 339,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(Marker, {\n        position: position,\n        children: /*#__PURE__*/_jsxDEV(Popup, {\n          children: [\"Your location: \", positionAddress, /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 344,\n            columnNumber: 45\n          }, this), \"Coordinates: \", position[0].toFixed(6), \", \", position[1].toFixed(6)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 343,\n          columnNumber: 11\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 342,\n        columnNumber: 9\n      }, this), destination && /*#__PURE__*/_jsxDEV(Marker, {\n        position: destination,\n        icon: destinationIcon,\n        children: /*#__PURE__*/_jsxDEV(Popup, {\n          children: /*#__PURE__*/_jsxDEV(\"div\", {\n            children: [/*#__PURE__*/_jsxDEV(\"strong\", {\n              children: \"Destination:\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 354,\n              columnNumber: 17\n            }, this), \" \", destinationAddress, /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 354,\n              columnNumber: 67\n            }, this), /*#__PURE__*/_jsxDEV(\"strong\", {\n              children: \"Coordinates:\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 355,\n              columnNumber: 17\n            }, this), \" \", destination[0].toFixed(6), \", \", destination[1].toFixed(6)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 353,\n            columnNumber: 15\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 352,\n          columnNumber: 13\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 351,\n        columnNumber: 11\n      }, this), /*#__PURE__*/_jsxDEV(Marker, {\n        position: mapCenter,\n        icon: centerIcon,\n        children: /*#__PURE__*/_jsxDEV(Popup, {\n          children: /*#__PURE__*/_jsxDEV(\"div\", {\n            children: [/*#__PURE__*/_jsxDEV(\"strong\", {\n              children: \"Map Center:\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 365,\n              columnNumber: 15\n            }, this), \" \", Array.isArray(mapCenter) ? `${(_mapCenter$ = mapCenter[0]) === null || _mapCenter$ === void 0 ? void 0 : _mapCenter$.toFixed(6)}, ${(_mapCenter$2 = mapCenter[1]) === null || _mapCenter$2 === void 0 ? void 0 : _mapCenter$2.toFixed(6)}` : 'Invalid coordinates']\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 364,\n            columnNumber: 13\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 363,\n          columnNumber: 11\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 362,\n        columnNumber: 9\n      }, this), route && /*#__PURE__*/_jsxDEV(Polyline, {\n        positions: route,\n        color: \"blue\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 371,\n        columnNumber: 19\n      }, this), vehicleMarkers.map((vehicle, index) => /*#__PURE__*/_jsxDEV(Marker, {\n        position: vehicle.position,\n        icon: vehicleIcon,\n        children: /*#__PURE__*/_jsxDEV(Popup, {\n          children: /*#__PURE__*/_jsxDEV(\"div\", {\n            children: [/*#__PURE__*/_jsxDEV(\"strong\", {\n              children: \"Line:\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 382,\n              columnNumber: 17\n            }, this), \" \", vehicle.lineNumber, /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 382,\n              columnNumber: 60\n            }, this), /*#__PURE__*/_jsxDEV(\"strong\", {\n              children: \"Vehicle:\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 383,\n              columnNumber: 17\n            }, this), \" \", vehicle.vehicleRef, /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 383,\n              columnNumber: 63\n            }, this), /*#__PURE__*/_jsxDEV(\"strong\", {\n              children: \"Expected arrival:\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 384,\n              columnNumber: 17\n            }, this), \" \", vehicle.expectedArrival, /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 384,\n              columnNumber: 77\n            }, this), /*#__PURE__*/_jsxDEV(\"strong\", {\n              children: \"Distance from stop:\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 385,\n              columnNumber: 17\n            }, this), \" \", vehicle.distanceFromStop, \" m\"]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 381,\n            columnNumber: 15\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 380,\n          columnNumber: 13\n        }, this)\n      }, `vehicle-${index}`, false, {\n        fileName: _jsxFileName,\n        lineNumber: 375,\n        columnNumber: 11\n      }, this)), optimizedRouteShape && optimizedRouteShape.length > 0 && /*#__PURE__*/_jsxDEV(Polyline, {\n        positions: optimizedRouteShape,\n        pathOptions: {\n          color: 'red',\n          weight: 3,\n          opacity: 0.7,\n          dashArray: '5, 5',\n          lineCap: 'round'\n        }\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 393,\n        columnNumber: 11\n      }, this), stops.map(stop => /*#__PURE__*/_jsxDEV(Marker, {\n        position: [stop.lat, stop.lon],\n        icon: stop.stopId === selectedStop ? centerIcon : stopIcon,\n        children: /*#__PURE__*/_jsxDEV(Popup, {\n          children: /*#__PURE__*/_jsxDEV(\"div\", {\n            children: [/*#__PURE__*/_jsxDEV(\"strong\", {\n              children: \"Stop:\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 414,\n              columnNumber: 17\n            }, this), \" \", stop.stopName, /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 414,\n              columnNumber: 55\n            }, this), /*#__PURE__*/_jsxDEV(\"strong\", {\n              children: \"ID:\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 415,\n              columnNumber: 17\n            }, this), \" \", stop.stopId, /*#__PURE__*/_jsxDEV(\"br\", {}, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 415,\n              columnNumber: 51\n            }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n              onClick: () => handleSetStartPoint([stop.lat, stop.lon]),\n              children: \"Set as starting point\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 416,\n              columnNumber: 17\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 413,\n            columnNumber: 15\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 412,\n          columnNumber: 13\n        }, this)\n      }, `stop-${stop.stopId}`, false, {\n        fileName: _jsxFileName,\n        lineNumber: 407,\n        columnNumber: 11\n      }, this))]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 325,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 311,\n    columnNumber: 5\n  }, this);\n}\n_s2(MapView, \"IAzli/XYxjKvRhj9uWZd+ZrXagk=\");\n_c = MapView;\nexport default MapView;\nvar _c;\n$RefreshReg$(_c, \"MapView\");","map":{"version":3,"names":["useEffect","useState","useRef","useMemo","MapContainer","TileLayer","Marker","Popup","Polyline","useMap","L","axios","TrackMapMovement","UpdateMapView","fetchAddress","findRoute","configureDefaultLeafletIcons","destinationIcon","centerIcon","vehicleIcon","stopIcon","MapControls","jsxDEV","_jsxDEV","simplifyShape","points","tolerance","length","dummyMap","map","document","createElement","rdp","pts","start","end","epsilon","dmax","index","line","polyline","lineLatLngs","getLatLngs","i","point","latLng","distance","GeometryUtil","distanceSegment","result","res1","res2","push","slice","decimate","factor","filter","_","idx","decimated","adjustedTolerance","Math","log10","simplified","remove","err","console","error","MapView","latitude","longitude","destination","onDestinationSet","startingPoint","mapCenter","initialMapCenter","vehicleMarkers","routeShape","stops","selectedStop","center","_s2","_s","$RefreshSig$","_mapCenter$","_mapCenter$2","position","setPosition","positionAddress","setPositionAddress","destinationAddress","setDestinationAddress","route","setRoute","searchQuery","setSearchQuery","searchError","setSearchError","mapReady","setMapReady","setMapCenter","style","innerHTML","head","appendChild","removeChild","newCenter","optimizedRouteShape","Array","isArray","log","round","MapEffect","fittedRef","routeIdRef","processingRef","currentRouteId","JSON","stringify","current","setTimeout","bounds","reduce","extend","latLngBounds","fitBounds","padding","maxZoom","animate","e","handleSearch","trim","response","get","encodeURIComponent","data","lat","lon","parseFloat","handleSetStartPoint","handleSetDestinationPoint","newDestination","handleKeyPress","key","handleFindRoute","MAX_RETRIES","attempts","routeData","status","height","width","children","fileName","_jsxFileName","lineNumber","columnNumber","zoom","zoomControl","whenReady","preferCanvas","url","attribution","toFixed","icon","positions","color","vehicle","vehicleRef","expectedArrival","distanceFromStop","pathOptions","weight","opacity","dashArray","lineCap","stop","stopId","stopName","onClick","_c","$RefreshReg$"],"sources":["/home/yaniv/101_coding/publicTransportation/react/public-transportation/src/MapView.js"],"sourcesContent":["import { useEffect, useState, useRef, useMemo } from 'react';\nimport './App.css';\nimport { MapContainer, TileLayer, Marker, Popup, Polyline, useMap } from 'react-leaflet';\nimport L from 'leaflet';  // Added this import to fix the 'L is not defined' error\nimport 'leaflet/dist/leaflet.css';\nimport axios from 'axios';\nimport { TrackMapMovement, UpdateMapView, fetchAddress, findRoute } from './components/map/MapUtilities';\nimport { configureDefaultLeafletIcons, destinationIcon, centerIcon, vehicleIcon, stopIcon } from './components/map/MapMarkers';\nimport MapControls from './components/map/MapControls';\n\n// Configure default Leaflet icons\nconfigureDefaultLeafletIcons();\n\n/**\n * Simplifies a polyline by reducing the number of points\n * Uses the Ramer-Douglas-Peucker algorithm\n * @param {Array} points - Array of [lat, lng] coordinates\n * @param {Number} tolerance - Higher values mean more simplification\n * @returns {Array} - Simplified array of points\n */\nfunction simplifyShape(points, tolerance = 0.0001) {\n  if (!points || points.length <= 2) return points;\n  \n  // Create map instance at the beginning so it's available to all inner functions\n  const dummyMap = L.map(document.createElement('div'));\n  \n  const rdp = (pts, start, end, epsilon) => {\n    // Find the point with the maximum distance\n    let dmax = 0;\n    let index = 0;\n    \n    const line = L.polyline([pts[start], pts[end]]);\n    const lineLatLngs = line.getLatLngs();\n    \n    for (let i = start + 1; i < end; i++) {\n      const point = L.latLng(pts[i]);\n      const distance = L.GeometryUtil.distanceSegment(dummyMap, point, lineLatLngs[0], lineLatLngs[1]);\n      if (distance > dmax) {\n        index = i;\n        dmax = distance;\n      }\n    }\n    \n    // If max distance is greater than epsilon, recursively simplify\n    const result = [];\n    if (dmax > epsilon) {\n      const res1 = rdp(pts, start, index, epsilon);\n      const res2 = rdp(pts, index, end, epsilon);\n      \n      // Concat the results, removing the duplicate point\n      result.push(...res1.slice(0, -1));\n      result.push(...res2);\n    } else {\n      result.push(pts[start]);\n      result.push(pts[end]);\n    }\n    \n    return result;\n  };\n  \n  // Simple decimation as fallback - keep only every nth point\n  const decimate = (pts, factor = 4) => {\n    return pts.filter((_, idx) => idx % factor === 0 || idx === pts.length - 1);\n  };\n  \n  try {\n    // First do simple decimation to reduce the number of points\n    const decimated = points.length > 500 ? decimate(points) : points;\n    \n    // If we still have a lot of points, use RDP algorithm\n    if (decimated.length > 300) {\n      // For very large datasets, increase the tolerance\n      const adjustedTolerance = tolerance * Math.log10(decimated.length);\n      const simplified = rdp(decimated, 0, decimated.length - 1, adjustedTolerance);\n      dummyMap.remove(); // Clean up the map\n      return simplified;\n    }\n    \n    dummyMap.remove(); // Make sure to clean up\n    return decimated;\n  } catch (err) {\n    console.error('Error simplifying route shape:', err);\n    // Clean up the map in case of error\n    dummyMap.remove();\n    // Fall back to simple decimation\n    return decimate(points, 6);\n  }\n}\n\nfunction MapView({ \n  latitude, \n  longitude, \n  destination, \n  onDestinationSet, \n  startingPoint,\n  mapCenter: initialMapCenter,\n  vehicleMarkers = [],\n  routeShape = null,\n  stops = [],\n  selectedStop = null,\n  center \n}) {\n  const [position, setPosition] = useState([latitude, longitude]);\n  const [positionAddress, setPositionAddress] = useState('');\n  const [destinationAddress, setDestinationAddress] = useState('');\n  const [route, setRoute] = useState(null);\n  const [searchQuery, setSearchQuery] = useState('');\n  const [searchError, setSearchError] = useState(null);\n  const [mapReady, setMapReady] = useState(false);\n  \n  const [mapCenter, setMapCenter] = useState(center || initialMapCenter || [latitude, longitude]);\n\n  useEffect(() => {\n    const style = document.createElement('style');\n    style.innerHTML = `\n      .destination-marker {\n        filter: hue-rotate(120deg);\n      }\n    `;\n    document.head.appendChild(style);\n    return () => {\n      document.head.removeChild(style);\n    };\n  }, []);\n\n  useEffect(() => {\n    setPosition([latitude, longitude]);\n    fetchAddress(latitude, longitude, setPositionAddress);\n  }, [latitude, longitude]);\n\n  useEffect(() => {\n    if (destination) {\n      const newCenter = [\n        (position[0] + destination[0]) / 2,\n        (position[1] + destination[1]) / 2\n      ];\n      setMapCenter(newCenter);\n      fetchAddress(destination[0], destination[1], setDestinationAddress);\n    }\n  }, [position, destination]);\n\n  // Memoize and simplify the route shape to improve performance\n  const optimizedRouteShape = useMemo(() => {\n    if (!routeShape || !Array.isArray(routeShape) || routeShape.length < 3) {\n      return routeShape;\n    }\n    \n    console.log(`Simplifying route shape with ${routeShape.length} points...`);\n    \n    // Determine if we need to simplify (only for large routes)\n    if (routeShape.length > 300) {\n      // Stronger simplification for very large routes\n      const factor = routeShape.length > 1000 ? 0.00015 : 0.0001;\n      const simplified = simplifyShape(routeShape, factor);\n      console.log(`Simplified to ${simplified.length} points (${Math.round(simplified.length/routeShape.length*100)}%)`);\n      return simplified;\n    }\n    \n    return routeShape;\n  }, [routeShape]);\n\n  // Log routeShape when it changes to debug\n  useEffect(() => {\n    if (routeShape) {\n      console.log(\"Route shape received in MapView:\", routeShape.length, \"points\");\n      console.log(\"First point:\", routeShape[0]);\n      console.log(\"Last point:\", routeShape[routeShape.length - 1]);\n    }\n  }, [routeShape]);\n\n  // MapEffect component to update view and zoom when routeShape changes\n  const MapEffect = ({ routeShape }) => {\n    const map = useMap();\n    const fittedRef = useRef(false);\n    const routeIdRef = useRef(null);\n    const processingRef = useRef(false);\n    \n    // Generate a unique ID for the current route to detect changes\n    const currentRouteId = routeShape ? JSON.stringify(routeShape.slice(0, 2)) : null;\n    \n    useEffect(() => {\n      // Skip if processing is in progress or if this is the same route\n      if (processingRef.current || \n         (routeIdRef.current === currentRouteId && fittedRef.current)) {\n        return;\n      }\n      \n      // Only fit bounds if:\n      // 1. We have a valid route shape with points\n      // 2. Either we haven't fitted bounds yet, or the route has changed\n      if (routeShape && routeShape.length > 0) {\n        processingRef.current = true;\n        \n        try {\n          // Use setTimeout to give the browser a chance to breathe\n          setTimeout(() => {\n            try {\n              // Create a bounds object from the route shape\n              const bounds = routeShape.reduce((bounds, point) => {\n                bounds.extend(point);\n                return bounds;\n              }, L.latLngBounds(routeShape[0], routeShape[0]));\n              \n              // Fit the map to these bounds with some padding\n              map.fitBounds(bounds, { \n                padding: [50, 50],\n                maxZoom: 15, // Limit max zoom level\n                animate: true\n              });\n              console.log(\"Map fitted to route bounds\");\n              \n              // Mark that we've fitted bounds for this route\n              fittedRef.current = true;\n              routeIdRef.current = currentRouteId;\n            } catch (e) {\n              console.error(\"Error fitting map to route:\", e);\n            } finally {\n              processingRef.current = false;\n            }\n          }, 100);\n        } catch (e) {\n          console.error(\"Error in MapEffect timeout:\", e);\n          processingRef.current = false;\n        }\n      }\n    }, [map, routeShape, currentRouteId]);\n    \n    // Clean up function\n    useEffect(() => {\n      return () => {\n        processingRef.current = false;\n      };\n    }, []);\n    \n    return null;\n  };\n\n  const handleSearch = async () => {\n    if (!searchQuery.trim()) return;\n\n    try {\n      setSearchError(null);\n      const response = await axios.get(\n        `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(searchQuery)}&format=json`\n      );\n      if (response.data.length > 0) {\n        const { lat, lon } = response.data[0];\n        setMapCenter([parseFloat(lat), parseFloat(lon)]);\n      } else {\n        setSearchError('Location not found.');\n      }\n    } catch (error) {\n      setSearchError('Error fetching location. Please try again.');\n    }\n  };\n\n  const handleSetStartPoint = () => {\n    setPosition(mapCenter);\n    fetchAddress(mapCenter[0], mapCenter[1], setPositionAddress);\n  };\n\n  const handleSetDestinationPoint = () => {\n    const newDestination = mapCenter;\n    onDestinationSet(newDestination);\n    fetchAddress(newDestination[0], newDestination[1], setDestinationAddress);\n  };\n\n  const handleKeyPress = (e) => {\n    if (e.key === 'Enter') {\n      handleSearch();\n    }\n  };\n\n  const handleFindRoute = async () => {\n    if (!destination) {\n      setSearchError('Please set a destination first.');\n      return;\n    }\n\n    const MAX_RETRIES = 3;\n    let attempts = 0;\n\n    while (attempts < MAX_RETRIES) {\n      try {\n        setSearchError(null);\n        const routeData = await findRoute(position, destination);\n        \n        if (routeData) {\n          setRoute(routeData);\n          return;\n        } else {\n          setSearchError('No route found. Please try again with different locations.');\n          return;\n        }\n      } catch (error) {\n        attempts++;\n        if (attempts >= MAX_RETRIES) {\n          if (error.response && error.response.status === 403) {\n            setSearchError('Invalid API key or insufficient permissions.');\n          } else if (error.response && error.response.status === 503) {\n            setSearchError('Service unavailable. Please try again later.');\n          } else {\n            setSearchError('Error fetching route. Please try again.');\n          }\n        }\n      }\n    }\n  };\n\n  return (\n    <div style={{ height: '100vh', width: '100%' }}>\n      <MapControls \n        searchQuery={searchQuery}\n        setSearchQuery={setSearchQuery}\n        handleSearch={handleSearch}\n        handleKeyPress={handleKeyPress}\n        handleSetStartPoint={handleSetStartPoint}\n        handleSetDestinationPoint={handleSetDestinationPoint}\n        handleFindRoute={handleFindRoute}\n        searchError={searchError}\n        positionAddress={positionAddress}\n        destinationAddress={destinationAddress}\n      />\n      \n      <MapContainer \n        center={mapCenter} \n        zoom={13} \n        style={{ height: '100%', width: '100%' }} \n        zoomControl={false}\n        whenReady={() => setMapReady(true)}\n        preferCanvas={true} // Use canvas renderer for better performance\n      >\n        <TileLayer\n          url=\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\"\n          attribution='&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors'\n        />\n        <UpdateMapView position={mapCenter} />\n        <TrackMapMovement setMapCenter={setMapCenter} />\n        <MapEffect routeShape={optimizedRouteShape} />\n        \n        {/* User position marker */}\n        <Marker position={position}>\n          <Popup>\n            Your location: {positionAddress}<br/>\n            Coordinates: {position[0].toFixed(6)}, {position[1].toFixed(6)}\n          </Popup>\n        </Marker>\n        \n        {/* Destination marker */}\n        {destination && (\n          <Marker position={destination} icon={destinationIcon}>\n            <Popup>\n              <div>\n                <strong>Destination:</strong> {destinationAddress}<br/>\n                <strong>Coordinates:</strong> {destination[0].toFixed(6)}, {destination[1].toFixed(6)}\n              </div>\n            </Popup>\n          </Marker>\n        )}\n        \n        {/* Map center marker */}\n        <Marker position={mapCenter} icon={centerIcon}>\n          <Popup>\n            <div>\n              <strong>Map Center:</strong> {Array.isArray(mapCenter) ? `${mapCenter[0]?.toFixed(6)}, ${mapCenter[1]?.toFixed(6)}` : 'Invalid coordinates'}\n            </div>\n          </Popup>\n        </Marker>\n        \n        {/* Route display */}\n        {route && <Polyline positions={route} color=\"blue\" />}\n        \n        {/* Vehicle markers */}\n        {vehicleMarkers.map((vehicle, index) => (\n          <Marker \n            key={`vehicle-${index}`} \n            position={vehicle.position}\n            icon={vehicleIcon}\n          >\n            <Popup>\n              <div>\n                <strong>Line:</strong> {vehicle.lineNumber}<br/>\n                <strong>Vehicle:</strong> {vehicle.vehicleRef}<br/>\n                <strong>Expected arrival:</strong> {vehicle.expectedArrival}<br/>\n                <strong>Distance from stop:</strong> {vehicle.distanceFromStop} m\n              </div>\n            </Popup>\n          </Marker>\n        ))}\n        \n        {/* Route shape if available */}\n        {optimizedRouteShape && optimizedRouteShape.length > 0 && (\n          <Polyline \n            positions={optimizedRouteShape} \n            pathOptions={{ \n              color: 'red', \n              weight: 3, \n              opacity: 0.7,\n              dashArray: '5, 5',\n              lineCap: 'round'\n            }} \n          />\n        )}\n        \n        {/* Stop markers */}\n        {stops.map(stop => (\n          <Marker \n            key={`stop-${stop.stopId}`} \n            position={[stop.lat, stop.lon]}\n            icon={stop.stopId === selectedStop ? centerIcon : stopIcon}\n          >\n            <Popup>\n              <div>\n                <strong>Stop:</strong> {stop.stopName}<br/>\n                <strong>ID:</strong> {stop.stopId}<br/>\n                <button onClick={() => handleSetStartPoint([stop.lat, stop.lon])}>\n                  Set as starting point\n                </button>\n              </div>\n            </Popup>\n          </Marker>\n        ))}\n      </MapContainer>\n    </div>\n  );\n}\n\nexport default MapView;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}